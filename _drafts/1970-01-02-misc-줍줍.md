---
layout: post
date: 1970-01-01 00:00:00 +0900
title: '[misc] 줍줍'
categories:
  - misc
tags:
  - draft-permanantly
  - misc
  - note
  - code-snippet
  - settings
---

* Kramdown table of contents
{:toc .toc}


## 개요

뭔가 분류 하기 애매한 수준의 짧은 정보를 모아놓은 페이지.


## 젠킨스 배포 설정: 리모트 서버의 OS가 윈도우

1. war 배포
2. properties 가 spring 에서 제공하는 profile active 방식이 아니다. 
3. 젠킨스가 깃랩에서 소스를 가져와 maven 검증을 하고 tomcat 에 파일을 떨궈 데이터를 삭제후 빌드를 한다.
4. 최종적으로 톰캣 서비스를 멎춰서 properties 를 환경에 맞는 파일로 rename 하기위해 
   젠킨스 postBuildScript 플러그인을 설치하고 빌드후조치 -> Execute scripts -> add post build step -> add build stop -> 파워셸 배포 스크립트를 작성했다.

> -jar 실행 명령어가 들어있는 .bat 파일을 호출하는 nssm-2.24\win64 서비스를 등록하고 잰킨스 배포 후조치로 단순 서비스 재시작하는 배포스크립트가 있는 파워셸을 실행한다.

이게 배포 스크립트라던데?

```
### 원격 접속
Enter-PSSession -ComputerName 1.2.3.4 -Port 999 -Credential $mycreds

$port = 443

$foundProcesses = netstat -ano | findstr :$port
$activePortPattern = ":$port\s.+LISTENING\s+\d+$"
$pidNumberPattern = "\d+$"

# netstat -ano | findStr 443
# taskkill /pid 12756 /f
IF ($foundProcesses | Select-String -Pattern $activePortPattern -Quiet) {
  $matched = $foundProcesses | Select-String -Pattern $activePortPattern
  $firstMatch = $matched.Matches.Get(0).Value
  $pidNumber = [regex]::match($firstMatch, $pidNumberPattern).Value
  taskkill /pid $pidNumber /f
  Start-Sleep 3
  Write-Output ":::::::::: PROD-EBABCSMSAPP stop $pidNumber "
}

Write-Output ":::::::::: PROD-EBABCSMSAPP start"

$java = "C:\Program Files\Java\jdk\bin\java.exe"
Start-Process -FilePath $java `
              -ArgumentList ' -jar C:\abcd.jar" --spring.profiles.active=prod' `
```

(`spring.profiles.active`는 시스템 프로퍼티라서 `-D` 접두사가 필요한데 좀 이상한듯?)
